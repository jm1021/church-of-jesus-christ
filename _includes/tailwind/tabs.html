{% assign data = site.data[page.infoGraph] %}
<div class="container mx-auto p-6 bg-neutral-900 text-neutral-100 rounded-lg shadow-md">

  <!-- Top Custom Buttons -->
  {% if data.topButtons %}
    <div class="flex justify-center gap-4 mb-6">
      {% for btn in data.topButtons %}
        <a href="{{ site.baseurl }}{{ btn.url }}"
           class="px-5 py-2 rounded-lg font-semibold shadow transition-colors duration-200 {{ btn.color }}">
          {{ btn.text }}
        </a>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Tabs Navigation -->
  <div class="flex flex-wrap justify-center space-x-4 border-b border-neutral-800 pb-4">
    {% for topic in data.Topics %}
      <button class="tab-button px-4 py-2 text-neutral-400 hover:text-neutral-200 border-b-2 border-transparent hover:border-neutral-500 focus:outline-none focus:border-neutral-500" data-tab="tab-{{ forloop.index }}">
        {{ topic.title }}
      </button>
    {% endfor %}
  </div>

  <!-- Tab Content -->
  <div class="tab-content mt-6">
    {% for topic in data.Topics %}
      <div id="tab-{{ forloop.index }}" class="tab-pane transition-opacity duration-300 ease-in-out {% if forloop.first %}opacity-100{% else %}opacity-0 hidden{% endif %}">
        <h2 class="text-2xl font-bold mb-4 text-neutral-300">{{ topic.title }}</h2>
        
        <!-- Key Points -->
        <div class="bg-neutral-800 p-4 rounded-lg shadow mb-6">
          <h3 class="text-lg font-semibold mb-2 text-neutral-400">Key Points</h3>
          <ul class="list-disc list-inside text-sm text-neutral-300">
            {% for point in topic.keyPoints %}
              <li>{{ point | markdownify }}</li>
            {% endfor %}
          </ul>
        </div>

        <!-- JavaScript Section -->
        {% if topic.jsCode %}
        <div class="bg-neutral-800 p-4 rounded-lg shadow mb-6">
          <h3 class="text-lg font-semibold mb-2 text-neutral-400">JavaScript</h3>
          <!-- Code Block -->
          <pre class="bg-neutral-900 text-sm text-neutral-300 p-4 rounded-lg overflow-x-auto">
<code id="js-example-code-{{ forloop.index }}">
{{ topic.jsCode }}
</code>
          </pre>
          <button class="run-js-example px-3 py-1 bg-blue-700 rounded text-white font-semibold hover:bg-blue-800 transition mb-2" data-index="{{ forloop.index }}">Run Example</button>
          <div id="js-example-output-{{ forloop.index }}" class="bg-neutral-900 p-3 rounded text-sm mt-2"></div>
          <!-- Explanation -->
          <div class="mt-4">
            <p class="text-sm text-neutral-300">
              {{ topic.jsExplanation | markdownify }}
            </p>
          </div>
        </div>
        {% endif %}

        <!-- Try It Yourself Section (JavaScript) -->
        {% if topic.jsTryItDescription or topic.jsExpectedOutput %}
        <div class="bg-neutral-800 p-4 rounded-lg shadow mb-6">
          <h3 class="text-lg font-semibold mb-2 text-blue-300">Try It Yourself (JavaScript)</h3>
          {% if topic.jsTryItDescription %}
            <div class="mb-2 text-neutral-200 text-sm">{{ topic.jsTryItDescription }}</div>
          {% endif %}
          <textarea id="js-try-code-{{ forloop.index }}" class="w-full p-2 rounded bg-neutral-900 text-neutral-100 mb-2" rows="5" placeholder="Type your JavaScript code here..." data-expected-output="{{ topic.jsExpectedOutput | strip_newlines }}" data-hint="{{ topic.jsTryItHint | escape }}"></textarea>
          <button class="js-try-btn px-4 py-2 bg-blue-700 rounded text-white font-semibold hover:bg-blue-800 transition mb-2" data-index="{{ forloop.index }}">Run Code</button>
          <div id="js-try-output-{{ forloop.index }}" class="bg-neutral-900 p-3 rounded text-sm mt-2"></div>
        </div>
        {% endif %}

        <!-- Python Section -->
        {% if topic.pyCode %}
        <div class="bg-neutral-800 p-4 rounded-lg shadow">
          <h3 class="text-lg font-semibold mb-2 text-neutral-400">Python</h3>
          <!-- Code Block -->
          <pre class="bg-neutral-900 text-sm text-neutral-300 p-4 rounded-lg overflow-x-auto">
<code id="py-example-code-{{ forloop.index }}">
{{ topic.pyCode }}
</code>
          </pre>
          <button class="run-py-example px-3 py-1 bg-green-700 rounded text-white font-semibold hover:bg-green-800 transition mb-2" data-index="{{ forloop.index }}">Run Example</button>
          <div id="py-example-output-{{ forloop.index }}" class="bg-neutral-900 p-3 rounded text-sm mt-2"></div>
          <!-- Explanation -->
          <div class="mt-4">
            <p class="text-sm text-neutral-300">
              {{ topic.pyExplanation | markdownify }}
            </p>
          </div>
        </div>
        {% endif %}

        <!-- Try It Yourself Section (Python) -->
        {% if topic.pyTryItDescription or topic.pyExpectedOutput %}
        <div class="bg-neutral-800 p-4 rounded-lg shadow mb-6">
          <h3 class="text-lg font-semibold mb-2 text-green-300">Try It Yourself (Python)</h3>
          {% if topic.pyTryItDescription %}
            <div class="mb-2 text-neutral-200 text-sm">{{ topic.pyTryItDescription }}</div>
          {% endif %}
          <textarea id="py-try-code-{{ forloop.index }}" class="w-full p-2 rounded bg-neutral-900 text-neutral-100 mb-2" rows="5" placeholder="Type your Python code here..." data-expected-output="{{ topic.pyExpectedOutput | strip_newlines }}" data-hint="{{ topic.pyTryItHint | escape }}"></textarea>
          <button class="py-try-btn px-4 py-2 bg-green-700 rounded text-white font-semibold hover:bg-green-800 transition mb-2" data-index="{{ forloop.index }}">Run Code</button>
          <div id="py-try-output-{{ forloop.index }}" class="bg-neutral-900 p-3 rounded text-sm mt-2"></div>
        </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>
</div>

<script>
  // Smooth fade transition for tabs
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabPanes = document.querySelectorAll('.tab-pane');

  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      const target = button.getAttribute('data-tab');

      tabPanes.forEach(pane => {
        if (pane.id === target) {
          pane.classList.remove('hidden');
          setTimeout(() => {
            pane.classList.add('opacity-100');
            pane.classList.remove('opacity-0');
          }, 10);
        } else {
          pane.classList.remove('opacity-100');
          pane.classList.add('opacity-0');
          setTimeout(() => {
            pane.classList.add('hidden');
          }, 300); // match duration-300
        }
      });

      tabButtons.forEach(btn => btn.classList.remove('text-neutral-200', 'border-neutral-500'));
      button.classList.add('text-neutral-200', 'border-neutral-500');
    });
  });

  // JS Try It Yourself Handler & Run Example
  document.addEventListener('DOMContentLoaded', function() {
    // JavaScript Try It
    document.querySelectorAll('.js-try-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        const idx = btn.getAttribute('data-index');
        const textarea = document.getElementById('js-try-code-' + idx);
        const expectedOutput = textarea.getAttribute('data-expected-output');
        const code = textarea.value;
        let output = '';
        let success = false;
        const originalLog = console.log;
        console.log = function(msg) {
          output += msg + '\n';
        };
        try {
          eval(code);
          output = output.trim();
          if (output === expectedOutput) {
            document.getElementById('js-try-output-' + idx).innerHTML = `<span class="text-green-400 font-bold">✅ Correct!</span> Output: <pre class="inline">${output}</pre>`;
            success = true;
          } else {
            let hint = textarea.getAttribute('data-hint');
            let hintHtml = hint ? `<div class="text-yellow-300 text-xs mt-2">Hint: ${hint}</div>` : "";
            document.getElementById('js-try-output-' + idx).innerHTML =
              `<span class="text-red-400 font-bold">❌ Not quite.</span> Output: <pre class="inline">${output}</pre><br>Expected: <pre class="inline">${expectedOutput}</pre>${hintHtml}`;
          }
        } catch (e) {
          document.getElementById('js-try-output-' + idx).innerHTML = `<span class="text-red-400 font-bold">⚠️ Error:</span> ${e.message}`;
        }
        console.log = originalLog;
        return success;
      });
    });

    // JavaScript Run Example
    document.querySelectorAll('.run-js-example').forEach(function(btn) {
      btn.addEventListener('click', function() {
        const idx = btn.getAttribute('data-index');
        const code = document.getElementById('js-example-code-' + idx).innerText;
        let output = '';
        const originalLog = console.log;
        console.log = function(msg) {
          output += msg + '\n';
        };
        try {
          eval(code);
          output = output.trim();
          document.getElementById('js-example-output-' + idx).innerHTML =
            `<pre class="bg-neutral-950 text-green-300 p-2 rounded">${output || '[no output]'}</pre>`;
        } catch (e) {
          document.getElementById('js-example-output-' + idx).innerHTML =
            `<span class="text-red-400 font-bold">⚠️ Error:</span> ${e.message}`;
        }
        console.log = originalLog;
      });
    });

    // Python Try It
    document.querySelectorAll('.py-try-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        const idx = btn.getAttribute('data-index');
        const textarea = document.getElementById('py-try-code-' + idx);
        const expectedOutput = textarea.getAttribute('data-expected-output').trim();
        const code = textarea.value;
        const outputDiv = document.getElementById('py-try-output-' + idx);
        outputDiv.innerHTML = `<span class="text-yellow-400 font-bold">⏳ Running Python code...</span>`;
        fetch("https://emkc.org/api/v2/piston/execute", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            language: "python",
            version: "3.10.0",
            files: [{ name: "main.py", content: code }]
          })
        })
        .then(response => response.json())
        .then(data => {
          let output = "";
          let error = "";
          // Prefer run.output, fallback to output, and show stderr if present
          if (data.run && typeof data.run.output === "string") {
            output = data.run.output;
          } else if (typeof data.output === "string") {
            output = data.output;
          }
          if (data.run && typeof data.run.stderr === "string" && data.run.stderr.trim() !== "") {
            error = data.run.stderr;
          } else if (typeof data.stderr === "string" && data.stderr.trim() !== "") {
            error = data.stderr;
          }
          output = output.trim();
          if (error) {
            outputDiv.innerHTML = `<span class="text-red-400 font-bold">⚠️ Python Error:</span> <pre class="inline">${error}</pre>`;
            return;
          }
          if (output === expectedOutput) {
            outputDiv.innerHTML = `<span class="text-green-400 font-bold">✅ Correct!</span> Output: <pre class="inline">${output}</pre>`;
          } else {
            let hint = textarea.getAttribute('data-hint');
            let hintHtml = hint ? `<div class="text-yellow-300 text-xs mt-2">Hint: ${hint}</div>` : "";
            outputDiv.innerHTML =
              `<span class="text-red-400 font-bold">❌ Not quite.</span> Output: <pre class="inline">${output || '[blank]'}</pre><br>Expected: <pre class="inline">${expectedOutput}</pre>${hintHtml}`;
            if (!output && !hint) {
              outputDiv.innerHTML += `<div class="text-yellow-300 text-xs mt-2">Hint: Make sure your code prints something and does not have errors.</div>`;
            }
          }
        })
        .catch(e => {
          outputDiv.innerHTML = `<span class="text-red-400 font-bold">⚠️ Error:</span> ${e.message}`;
        });
      });
    });

    // Python Run Example
    document.querySelectorAll('.run-py-example').forEach(function(btn) {
      btn.addEventListener('click', function() {
        const idx = btn.getAttribute('data-index');
        const code = document.getElementById('py-example-code-' + idx).innerText;
        const outputDiv = document.getElementById('py-example-output-' + idx);
        outputDiv.innerHTML = `<span class="text-yellow-400 font-bold">⏳ Running Python code...</span>`;
        fetch("https://emkc.org/api/v2/piston/execute", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            language: "python",
            version: "3.10.0",
            files: [{ name: "main.py", content: code }]
          })
        })
        .then(response => response.json())
        .then(data => {
          let output = "";
          let error = "";
          if (data.run && typeof data.run.output === "string") {
            output = data.run.output;
          } else if (typeof data.output === "string") {
            output = data.output;
          }
          if (data.run && typeof data.run.stderr === "string" && data.run.stderr.trim() !== "") {
            error = data.run.stderr;
          } else if (typeof data.stderr === "string" && data.stderr.trim() !== "") {
            error = data.stderr;
          }
          output = output.trim();
          if (error) {
            outputDiv.innerHTML = `<span class="text-red-400 font-bold">⚠️ Python Error:</span> <pre class="inline">${error}</pre>`;
            return;
          }
          outputDiv.innerHTML = `<pre class="bg-neutral-950 text-green-300 p-2 rounded">${output || '[no output]'}</pre>`;
        })
        .catch(e => {
          outputDiv.innerHTML = `<span class="text-red-400 font-bold">⚠️ Error:</span> ${e.message}`;
        });
      });
    });
  });
</script>
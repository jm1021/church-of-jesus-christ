<!-- Grading Feedback Tool with Threaded Comments -->
<style>
.grading-feedback-container {
  background: #1a1a1a;
  border: 2px solid #0f0;
  border-radius: 10px;
  padding: 2rem;
  margin: 2rem 0;
  max-width: 900px;
}

.grading-feedback-container h3 {
  color: #0f0;
  margin-bottom: 1.5rem;
  text-align: center;
}

.feedback-form {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.form-group label {
  color: #0f0;
  font-weight: bold;
  font-size: 0.95rem;
}

.form-group input,
.form-group textarea,
.form-group select {
  background: #222;
  border: 1px solid #444;
  border-radius: 6px;
  padding: 0.75rem;
  color: #fff;
  font-family: inherit;
  font-size: 1rem;
  transition: border-color 0.3s;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
  outline: none;
  border-color: #0f0;
}

.form-group textarea {
  resize: vertical;
  min-height: 100px;
}

.submit-feedback-btn {
  background: #0f0;
  color: #000;
  border: none;
  border-radius: 6px;
  padding: 0.75rem 1.5rem;
  font-size: 1rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
}

.submit-feedback-btn:hover {
  background: #0c0;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 255, 0, 0.3);
}

.submit-feedback-btn:disabled {
  background: #555;
  cursor: not-allowed;
  transform: none;
}

.feedback-message {
  padding: 1rem;
  border-radius: 6px;
  margin-top: 1rem;
  text-align: center;
  display: none;
}

.feedback-message.success {
  background: rgba(0, 255, 0, 0.1);
  border: 1px solid #0f0;
  color: #0f0;
}

.feedback-message.error {
  background: rgba(255, 0, 0, 0.1);
  border: 1px solid #f00;
  color: #f00;
}

.feedback-history {
  margin-top: 2rem;
  border-top: 1px solid #444;
  padding-top: 2rem;
}

.feedback-history h4 {
  color: #0f0;
  margin-bottom: 1.5rem;
}

.feedback-thread {
  background: #222;
  border-left: 3px solid #0f0;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  border-radius: 6px;
}

.thread-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 1rem;
  flex-wrap: wrap;
  gap: 0.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid #333;
}

.thread-info {
  flex: 1;
}

.feedback-name {
  color: #0f0;
  font-weight: bold;
  font-size: 1.1rem;
}

.feedback-timestamp {
  color: #888;
  font-size: 0.85rem;
  margin-top: 0.25rem;
}

.feedback-grade {
  background: #333;
  color: #0f0;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  font-weight: bold;
  font-size: 0.95rem;
}

.feedback-submission {
  color: #ccc;
  margin: 1rem 0;
  line-height: 1.6;
  padding: 1rem;
  background: #1a1a1a;
  border-radius: 4px;
}

.thread-replies {
  margin-top: 1.5rem;
  padding-left: 1.5rem;
  border-left: 2px solid #444;
}

.reply-item {
  background: #1a1a1a;
  padding: 1rem;
  margin-bottom: 1rem;
  border-radius: 4px;
  border-left: 2px solid #666;
}

.reply-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.5rem;
  align-items: center;
}

.reply-author {
  color: #0f0;
  font-weight: bold;
  font-size: 0.9rem;
}

.reply-timestamp {
  color: #666;
  font-size: 0.8rem;
}

.reply-content {
  color: #aaa;
  line-height: 1.5;
  font-size: 0.95rem;
}

.reply-form {
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid #333;
}

.reply-form textarea {
  width: 100%;
  background: #1a1a1a;
  border: 1px solid #444;
  border-radius: 4px;
  padding: 0.75rem;
  color: #fff;
  font-family: inherit;
  font-size: 0.95rem;
  min-height: 80px;
  resize: vertical;
}

.reply-form textarea:focus {
  outline: none;
  border-color: #0f0;
}

.reply-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 0.75rem;
}

.reply-btn,
.cancel-reply-btn {
  padding: 0.5rem 1rem;
  border-radius: 4px;
  font-size: 0.9rem;
  cursor: pointer;
  border: none;
  transition: all 0.2s;
}

.reply-btn {
  background: #0f0;
  color: #000;
  font-weight: bold;
}

.reply-btn:hover {
  background: #0c0;
}

.cancel-reply-btn {
  background: #333;
  color: #fff;
}

.cancel-reply-btn:hover {
  background: #444;
}

.add-reply-btn {
  background: #333;
  color: #0f0;
  border: 1px solid #0f0;
  border-radius: 4px;
  padding: 0.5rem 1rem;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 0.5rem;
}

.add-reply-btn:hover {
  background: #0f0;
  color: #000;
}

.clear-history-btn {
  background: #333;
  color: #f00;
  border: 1px solid #f00;
  border-radius: 6px;
  padding: 0.5rem 1rem;
  font-size: 0.9rem;
  cursor: pointer;
  margin-top: 1rem;
  transition: all 0.3s;
}

.clear-history-btn:hover {
  background: #f00;
  color: #000;
}

.reply-count {
  color: #888;
  font-size: 0.85rem;
  margin-top: 0.5rem;
}
</style>

<div class="grading-feedback-container">
  <h3>üìù Submit Your Grade Feedback</h3>
  
  <form class="feedback-form" id="gradingFeedbackForm">
    <div class="form-group">
      <label for="studentName">Student Name *</label>
      <input type="text" id="studentName" name="studentName" placeholder="Enter your name" required>
      <small id="loginHint" style="color: #888; display: none; margin-top: 0.25rem;">‚úì Auto-filled from your login</small>
    </div>

    <div class="form-group">
      <label for="gradeReceived">Grade Received *</label>
      <select id="gradeReceived" name="gradeReceived" required>
        <option value="">Select grade...</option>
        <option value="A+ (97-100%)">A+ (97-100%)</option>
        <option value="A (93-96%)">A (93-96%)</option>
        <option value="A- (90-92%)">A- (90-92%)</option>
        <option value="B+ (87-89%)">B+ (87-89%)</option>
        <option value="B (83-86%)">B (83-86%)</option>
        <option value="B- (80-82%)">B- (80-82%)</option>
        <option value="C+ (77-79%)">C+ (77-79%)</option>
        <option value="C (73-76%)">C (73-76%)</option>
        <option value="C- (70-72%)">C- (70-72%)</option>
        <option value="D (60-69%)">D (60-69%)</option>
        <option value="F (Below 60%)">F (Below 60%)</option>
        <option value="Not Yet Graded">Not Yet Graded</option>
      </select>
    </div>

    <div class="form-group">
      <label for="additionalComments">Submission / Comments *</label>
      <textarea id="additionalComments" name="additionalComments" placeholder="Share your thoughts, challenges, or reflections on this assignment..." required></textarea>
    </div>

    <button type="submit" class="submit-feedback-btn">Submit Feedback</button>
  </form>

  <div id="feedbackMessage" class="feedback-message"></div>

  <div class="feedback-history" id="feedbackHistory" style="display: none;">
    <h4>üí¨ Submission Threads</h4>
    <div id="feedbackThreadsList"></div>
    <button class="clear-history-btn" onclick="clearFeedbackHistory()">Clear All Threads</button>
  </div>
</div>

<script>
(function() {
  const STORAGE_KEY = 'lesson_grading_feedback_' + (window.location.pathname || 'default');
  
  function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
  }
  
  function saveFeedback(feedback) {
    const threads = loadThreads();
    threads.push({
      id: generateId(),
      ...feedback,
      timestamp: new Date().toISOString(),
      pageUrl: window.location.href,
      pageTitle: document.title,
      replies: []
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(threads));
  }
  
  function loadThreads() {
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  }
  
  function saveThreads(threads) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(threads));
  }
  
  function addReply(threadId, replyData) {
    const threads = loadThreads();
    const thread = threads.find(t => t.id === threadId);
    if (thread) {
      thread.replies.push({
        id: generateId(),
        ...replyData,
        timestamp: new Date().toISOString()
      });
      saveThreads(threads);
    }
  }
  
  function showReplyForm(threadId) {
    // Hide all other reply forms first
    document.querySelectorAll('.reply-form').forEach(form => {
      if (form.dataset.threadId !== threadId) {
        form.style.display = 'none';
      }
    });
    
    const form = document.querySelector(`.reply-form[data-thread-id="${threadId}"]`);
    if (form) {
      form.style.display = 'block';
      
      // Auto-fill name if user is logged in
      const nameInput = form.querySelector('.reply-name-input');
      if (window.user && window.user.name && !nameInput.value) {
        nameInput.value = window.user.name;
        nameInput.style.borderColor = '#0f0';
      }
      
      form.querySelector('textarea').focus();
    }
  }
  
  function hideReplyForm(threadId) {
    const form = document.querySelector(`.reply-form[data-thread-id="${threadId}"]`);
    if (form) {
      form.style.display = 'none';
      form.querySelector('textarea').value = '';
    }
  }
  
  function submitReply(threadId) {
    const form = document.querySelector(`.reply-form[data-thread-id="${threadId}"]`);
    const nameInput = form.querySelector('.reply-name-input');
    const contentInput = form.querySelector('.reply-content-input');
    
    const replyName = nameInput.value.trim();
    const replyContent = contentInput.value.trim();
    
    if (!replyName || !replyContent) {
      showMessage('Please enter both your name and reply content', 'error');
      return;
    }
    
    addReply(threadId, {
      author: replyName,
      content: replyContent
    });
    
    showMessage('‚úÖ Reply added successfully!', 'success');
    hideReplyForm(threadId);
    displayThreads();
  }
  
  function displayThreads() {
    const threads = loadThreads();
    const historyDiv = document.getElementById('feedbackHistory');
    const listDiv = document.getElementById('feedbackThreadsList');
    
    if (threads.length === 0) {
      historyDiv.style.display = 'none';
      return;
    }
    
    historyDiv.style.display = 'block';
    listDiv.innerHTML = '';
    
    // Show newest first
    threads.slice().reverse().forEach((thread) => {
      const threadDiv = document.createElement('div');
      threadDiv.className = 'feedback-thread';
      
      let repliesHtml = '';
      if (thread.replies && thread.replies.length > 0) {
        repliesHtml = `
          <div class="thread-replies">
            <div class="reply-count">üí¨ ${thread.replies.length} ${thread.replies.length === 1 ? 'reply' : 'replies'}</div>
            ${thread.replies.map(reply => `
              <div class="reply-item">
                <div class="reply-header">
                  <span class="reply-author">${reply.author}</span>
                  <span class="reply-timestamp">${new Date(reply.timestamp).toLocaleString()}</span>
                </div>
                <div class="reply-content">${reply.content}</div>
              </div>
            `).join('')}
          </div>
        `;
      }
      
      threadDiv.innerHTML = `
        <div class="thread-header">
          <div class="thread-info">
            <div class="feedback-name">${thread.studentName}</div>
            <div class="feedback-timestamp">${new Date(thread.timestamp).toLocaleString()}</div>
          </div>
          <div class="feedback-grade">${thread.gradeReceived}</div>
        </div>
        <div class="feedback-submission">${thread.additionalComments}</div>
        ${repliesHtml}
        <button class="add-reply-btn" onclick="showReplyForm('${thread.id}')">üí¨ Add Reply / Feedback</button>
        <div class="reply-form" data-thread-id="${thread.id}" style="display: none;">
          <input type="text" class="reply-name-input" placeholder="Your name" value="${window.user && window.user.name ? window.user.name : ''}" style="width: 100%; background: #1a1a1a; border: 1px solid ${window.user && window.user.name ? '#0f0' : '#444'}; border-radius: 4px; padding: 0.5rem; color: #fff; margin-bottom: 0.5rem;">
          <textarea class="reply-content-input" placeholder="Write your feedback or reply..."></textarea>
          <div class="reply-actions">
            <button class="reply-btn" onclick="submitReply('${thread.id}')">Post Reply</button>
            <button class="cancel-reply-btn" onclick="hideReplyForm('${thread.id}')">Cancel</button>
          </div>
        </div>
      `;
      
      listDiv.appendChild(threadDiv);
    });
  }
  
  function showMessage(message, type) {
    const msgDiv = document.getElementById('feedbackMessage');
    msgDiv.textContent = message;
    msgDiv.className = 'feedback-message ' + type;
    msgDiv.style.display = 'block';
    
    setTimeout(() => {
      msgDiv.style.display = 'none';
    }, 5000);
  }
  
  // Auto-fill name from login if available
  function autoFillUserName() {
    const nameInput = document.getElementById('studentName');
    const loginHint = document.getElementById('loginHint');
    
    // Check if user is logged in (from login.js which sets window.user)
    if (window.user && window.user.name) {
      nameInput.value = window.user.name;
      loginHint.style.display = 'block';
      nameInput.style.borderColor = '#0f0';
    }
  }
  
  // Try to auto-fill immediately
  autoFillUserName();
  
  // Also try again after a short delay in case login.js hasn't loaded yet
  setTimeout(autoFillUserName, 500);
  
  // Listen for custom event if login happens after page load
  window.addEventListener('userDataLoaded', autoFillUserName);
  
  const form = document.getElementById('gradingFeedbackForm');
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
      studentName: document.getElementById('studentName').value.trim(),
      gradeReceived: document.getElementById('gradeReceived').value,
      additionalComments: document.getElementById('additionalComments').value.trim()
    };
    
    if (!formData.studentName || !formData.gradeReceived || !formData.additionalComments) {
      showMessage('Please fill in all fields', 'error');
      return;
    }
    
    saveFeedback(formData);
    showMessage('‚úÖ Feedback submitted successfully!', 'success');
    
    // Reset form but keep auto-filled name
    const savedName = formData.studentName;
    form.reset();
    if (window.user && window.user.name) {
      document.getElementById('studentName').value = savedName;
      document.getElementById('loginHint').style.display = 'block';
    }
    
    // Update display
    displayThreads();
  });
  
  // Make functions globally available
  window.showReplyForm = showReplyForm;
  window.hideReplyForm = hideReplyForm;
  window.submitReply = submitReply;
  
  window.clearFeedbackHistory = function() {
    if (confirm('Are you sure you want to clear all feedback threads for this lesson?')) {
      localStorage.removeItem(STORAGE_KEY);
      displayThreads();
      showMessage('All threads cleared', 'success');
    }
  };
  
  // Load threads on page load
  displayThreads();
})();
</script>

